{% extends 'layouts/app.html' %}
{% load static %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="list-order-header">
                        <div class="d-flex justify-content-between">
                            <h4>Edit Order: {{ order.orderId }}</h4>
                            <a class="btn btn-primary" href="{% url 'base:getOrders' %}"><i class="fa fa-eye"></i> Back to Orders</a>
                        </div>
                    </div>
                    <hr>
                    <form method="post" id="order-form">
                        {% csrf_token %}
                        {{ order_form.non_field_errors }}
                        <div class="mb-3">
                            <label class="form-label">{{ order_form.client.label }}</label>
                            <div class="input-group">
                                <select id="client-select" name="client" class="form-select" required>
                                    <option value="">Select a client</option>
                                    {% for client in order_form.fields.client.queryset %}
                                        <option value="{{ client.id }}" {% if client.id == order.client.id %}selected{% endif %}>{{ client.phone_number }} ({{ client.name }})</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addClientModal">Add Client</button>
                            </div>
                            {% for error in order_form.client.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ order_form.destination.label }}</label>
                            {{ order_form.destination }}
                            {% for error in order_form.destination.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <hr>

                        <h5>Order Products</h5>
                        <table class="table table-bordered" id="order-products-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Size</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total Size</th>
                                    <th>Total Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for form in order_product_forms %}
                                <tr class="order-product-form" data-form-prefix="{{ forloop.counter0 }}">
                                    <td>
                                        <select name="{{ forloop.counter0 }}-product" class="form-select product-select" required>
                                            <option value="">Select a product</option>
                                            {% for product in form.fields.product.queryset %}
                                                <option value="{{ product.id }}" {% if form.instance.product.id == product.id %}selected{% endif %}>{{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                        {% for error in form.product.errors %}
                                            <div class="text-danger">{{ error }}</div>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <input type="number" name="{{ forloop.counter0 }}-size" class="form-control size-input" min="0" step="0.1" value="{{ form.instance.size }}" required>
                                        {% for error in form.size.errors %}
                                            <div class="text-danger">{{ error }}</div>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <input type="number" name="{{ forloop.counter0 }}-quantity" class="form-control quantity-input" min="1" value="{{ form.instance.quantity }}" required>
                                        {% for error in form.quantity.errors %}
                                            <div class="text-danger">{{ error }}</div>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <input type="number" name="{{ forloop.counter0 }}-unit_price" class="form-control unit-price-input" min="0" step="0.01" value="{{ form.instance.unit_price }}" required>
                                        {% for error in form.unit_price.errors %}
                                            <div class="text-danger">{{ error }}</div>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <input type="text" name="{{ forloop.counter0 }}-total_size" class="form-control total-size-input" value="{{ form.instance.total_size }}" readonly>
                                    </td>
                                    <td>
                                        <input type="text" name="{{ forloop.counter0 }}-total_price" class="form-control total-price-input" value="${{ form.instance.total_price }}" readonly>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger remove-order-product">Remove</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-secondary" id="add-order-product">Add Product</button>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">Grand Total:</label>
                            <input type="text" id="grand-total" class="form-control" value="${{ order.grand_total }}" readonly>
                        </div>

                        <div class="row mt-2">
                            <div class="col">
                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary">Update Order</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="add-client-form">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addClientModalLabel">Add New Client</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            {{ add_client_form.non_field_errors }}
            <div class="mb-3">
                <label class="form-label">{{ add_client_form.name.label }}</label>
                {{ add_client_form.name }}
                {% for error in add_client_form.name.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
            <div class="mb-3">
                <label class="form-label">{{ add_client_form.phone_number.label }}</label>
                {{ add_client_form.phone_number }}
                {% for error in add_client_form.phone_number.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
            <div class="mb-3">
                <label class="form-label">{{ add_client_form.destination.label }}</label>
                {{ add_client_form.destination }}
                {% for error in add_client_form.destination.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Client</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/jquery.min.js' %}"></script>
<script>
$(document).ready(function(){
    let orderProductIndex = {{ order_product_forms|length }};

    // Function to update grand total
    function updateGrandTotal() {
        let grandTotal = 0.00;
        $('.total-price-input').each(function(){
            let price = parseFloat($(this).val().replace('$', '')) || 0.00;
            grandTotal += price;
        });
        $('#grand-total').val('$' + grandTotal.toFixed(2));
    }

    // Function to update total size and total price
    function updateTotals(row) {
        let size = parseFloat(row.find('.size-input').val()) || 0.00;
        let quantity = parseInt(row.find('.quantity-input').val()) || 0;
        let unitPrice = parseFloat(row.find('.unit-price-input').val()) || 0.00;

        let totalSize = size * quantity;
        let totalPrice = size * unitPrice;

        row.find('.total-size-input').val(totalSize.toFixed(2));
        row.find('.total-price-input').val('$' + totalPrice.toFixed(2));

        updateGrandTotal();
    }

    // Add new order product row
    $('#add-order-product').click(function(){
        let newRow = `
            <tr class="order-product-form" data-form-prefix="${orderProductIndex}">
                <td>
                    <select name="${orderProductIndex}-product" class="form-select product-select" required>
                        <option value="">Select a product</option>
                        {% for product in order_product_forms.0.fields.product.queryset %}
                            <option value="{{ product.id }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <input type="number" name="${orderProductIndex}-size" class="form-control size-input" min="0" step="0.1" required>
                </td>
                <td>
                    <input type="number" name="${orderProductIndex}-quantity" class="form-control quantity-input" min="1" required>
                </td>
                <td>
                    <input type="number" name="${orderProductIndex}-unit_price" class="form-control unit-price-input" min="0" step="0.01" required>
                </td>
                <td>
                    <input type="text" name="${orderProductIndex}-total_size" class="form-control total-size-input" readonly>
                </td>
                <td>
                    <input type="text" name="${orderProductIndex}-total_price" class="form-control total-price-input" readonly>
                </td>
                <td>
                    <button type="button" class="btn btn-danger remove-order-product">Remove</button>
                </td>
            </tr>
        `;
        $('#order-products-table tbody').append(newRow);
        orderProductIndex++;
    });

    // Remove order product row
    $(document).on('click', '.remove-order-product', function(){
        $(this).closest('tr').remove();
        updateGrandTotal();
    });

    // Update totals on input change
    $(document).on('input', '.size-input, .quantity-input, .unit-price-input', function(){
        let row = $(this).closest('tr');
        updateTotals(row);
    });

    // Handle Add Client form submission via AJAX
    $('#add-client-form').submit(function(e){
        e.preventDefault();
        let form = $(this);
        $.ajax({
            url: "{% url 'base:addClient' %}",
            method: "POST",
            data: form.serialize(),
            success: function(response){
                // Assuming the server returns JSON with client id and name
                // Update the client select dropdown
                // For simplicity, reload the page to reflect the new client
                location.reload();
            },
            error: function(response){
                // Handle errors here
                alert('Error adding client. Please check the form and try again.');
            }
        });
    });
});
</script>
{% endblock %}
