{% extends 'layouts/app.html' %}
{% load static %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="list-order-header">
                        <div class="d-flex justify-content-between">
                            <h4>Add New Order</h4>
                            <a class="btn btn-primary" href="{% url 'base:getOrders' %}">
                                <i class="fa fa-eye"></i> Back to Orders
                            </a>
                        </div>
                    </div>
                    <hr>
                    <form method="post" id="order-form">
                        {% csrf_token %}
                        {{ order_form.non_field_errors }}
                        <div class="mb-3">
                            <label class="form-label">{{ order_form.client.label }}</label>
                            <div class="input-group">
                                <select id="client-select" name="client" class="form-select" required>
                                    <option value="">Select a client</option>
                                    {% for client in order_form.fields.client.queryset %}
                                        <option value="{{ client.id }}">{{ client.phone_number }} ({{ client.name }})</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" id="add-client-button">Add Client</button>
                            </div>
                            <div id="client-errors" class="text-danger">
                                {% for error in order_form.client.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ order_form.destination.label }}</label>
                            {{ order_form.destination }}
                            <div class="text-danger">
                                {% for error in order_form.destination.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        </div>

                        <hr>

                        <h5>Order Products</h5>
                        <table class="table table-bordered" id="order-products-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Size</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total Size</th>
                                    <th>Total Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="order-products-body">
                                <tr class="order-product-form" data-form-prefix="0">
                                    <td>
                                        <select name="0-product" class="form-select product-select" required>
                                            <option value="">Select a product</option>
                                            {% for product in order_product_forms.0.fields.product.queryset %}
                                                <option value="{{ product.id }}">{{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="text-danger product-error"></div>
                                    </td>
                                    <td>
                                        <input type="number" name="0-size" class="form-control size-input" min="0" step="0.1" required>
                                        <div class="text-danger size-error"></div>
                                    </td>
                                    <td>
                                        <input type="number" name="0-quantity" class="form-control quantity-input" min="1" required>
                                        <div class="text-danger quantity-error"></div>
                                    </td>
                                    <td>
                                        <input type="number" name="0-unit_price" class="form-control unit-price-input" min="0" step="0.01" required>
                                        <div class="text-danger unit-price-error"></div>
                                    </td>
                                    <td>
                                        <input type="text" name="0-total_size" class="form-control total-size-input" readonly>
                                    </td>
                                    <td>
                                        <input type="text" name="0-total_price" class="form-control total-price-input" readonly>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger remove-order-product">Remove</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-secondary" id="add-order-product">Add Product</button>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">Grand Total:</label>
                            <input type="text" id="grand-total" class="form-control" value="RWF 0.00" readonly>
                        </div>

                        <div class="row mt-2">
                            <div class="col">
                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary">Create Order</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="add-client-form">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addClientModalLabel">Add New Client</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div id="client-form-errors" class="text-danger mb-2"></div>
            <div class="mb-3">
                <label class="form-label">{{ add_client_form.name.label }}</label>
                {{ add_client_form.name }}
            </div>
            <div class="mb-3">
                <label class="form-label">{{ add_client_form.phone_number.label }}</label>
                {{ add_client_form.phone_number }}
            </div>
            <div class="mb-3">
                <label class="form-label">{{ add_client_form.destination.label }}</label>
                {{ add_client_form.destination }}
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Client</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let orderProductIndex = 1; // Starts from 1 as 0 is already present

    // Function to update grand total
    function updateGrandTotal() {
        let grandTotal = 0.00;
        document.querySelectorAll('.total-price-input').forEach(function(input) {
            let price = parseFloat(input.value.replace('RWF ', '')) || 0.00;
            grandTotal += price;
        });
        document.getElementById('grand-total').value = 'RWF ' + grandTotal.toFixed(2);
    }

    // Function to update total size and total price
    function updateTotals(row) {
        let sizeInput = row.querySelector('.size-input');
        let quantityInput = row.querySelector('.quantity-input');
        let unitPriceInput = row.querySelector('.unit-price-input');
        let totalSizeInput = row.querySelector('.total-size-input');
        let totalPriceInput = row.querySelector('.total-price-input');

        let size = parseFloat(sizeInput.value) || 0.00;
        let quantity = parseInt(quantityInput.value) || 0;
        let unitPrice = parseFloat(unitPriceInput.value) || 0.00;

        let totalSize = size * quantity;
        let totalPrice = size * unitPrice;

        totalSizeInput.value = totalSize.toFixed(2);
        totalPriceInput.value = 'RWF ' + totalPrice.toFixed(2);

        updateGrandTotal();
    }

    // Add new order product row
    document.getElementById('add-order-product').addEventListener('click', function() {
        let tableBody = document.getElementById('order-products-body');
        let newRow = document.createElement('tr');
        newRow.classList.add('order-product-form');
        newRow.setAttribute('data-form-prefix', orderProductIndex);

        newRow.innerHTML = `
            <td>
                <select name="${orderProductIndex}-product" class="form-select product-select" required>
                    <option value="">Select a product</option>
                    {% for product in order_product_forms.0.fields.product.queryset %}
                        <option value="{{ product.id }}">{{ product.name }}</option>
                    {% endfor %}
                </select>
                <div class="text-danger product-error"></div>
            </td>
            <td>
                <input type="number" name="${orderProductIndex}-size" class="form-control size-input" min="0" step="0.1" required>
                <div class="text-danger size-error"></div>
            </td>
            <td>
                <input type="number" name="${orderProductIndex}-quantity" class="form-control quantity-input" min="1" required>
                <div class="text-danger quantity-error"></div>
            </td>
            <td>
                <input type="number" name="${orderProductIndex}-unit_price" class="form-control unit-price-input" min="0" step="0.01" required>
                <div class="text-danger unit-price-error"></div>
            </td>
            <td>
                <input type="text" name="${orderProductIndex}-total_size" class="form-control total-size-input" readonly>
            </td>
            <td>
                <input type="text" name="${orderProductIndex}-total_price" class="form-control total-price-input" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-danger remove-order-product">Remove</button>
            </td>
        `;
        tableBody.appendChild(newRow);
        orderProductIndex++;
    });

    // Remove order product row
    document.getElementById('order-products-table').addEventListener('click', function(e) {
        if (e.target && e.target.matches('button.remove-order-product')) {
            let row = e.target.closest('tr');
            row.parentNode.removeChild(row);
            updateGrandTotal();
        }
    });

    // Update totals on input change
    document.getElementById('order-products-table').addEventListener('input', function(e) {
        if (e.target && (e.target.matches('.size-input') || e.target.matches('.quantity-input') || e.target.matches('.unit-price-input'))) {
            let row = e.target.closest('tr');
            updateTotals(row);
        }
    });

    // Handle Add Client form submission via Fetch API
    document.getElementById('add-client-form').addEventListener('submit', function(e) {
        e.preventDefault();
        let form = e.target;
        let formData = new FormData(form);

        fetch("{% url 'base:addClient' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close the modal
                let addClientModal = new bootstrap.Modal(document.getElementById('addClientModal'));
                addClientModal.hide();

                // Reset the form
                form.reset();
                document.getElementById('client-form-errors').innerHTML = '';

                // Add the new client to the client-select dropdown
                let clientSelect = document.getElementById('client-select');
                let newOption = document.createElement('option');
                newOption.value = data.client.id;
                newOption.textContent = `${data.client.phone_number} (${data.client.name})`;
                newOption.selected = true;
                clientSelect.appendChild(newOption);

                // Optionally, show a success message
                alert('Client added successfully!');
            } else {
                // Display errors
                let errors = JSON.parse(data.errors);
                let errorHtml = '';
                for (let field in errors) {
                    errors[field].forEach(error => {
                        errorHtml += `<p>${error.message}</p>`;
                    });
                }
                document.getElementById('client-form-errors').innerHTML = errorHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred while adding the client.');
        });
    });
});
</script>
{% endblock %}
